---
alwaysApply: true
---

# Terraform開発規約

## ガイドライン

- **ドキュメント参照**: HashiCorp Terraform公式ドキュメントとGCPプロバイダー公式ドキュメントを優先
- **フォーマッター**: `terraform fmt`を使用（自動フォーマット）
- **リンター**: `tflint`を使用（推奨）
- **プロジェクト構成**: `gcp/`ディレクトリ配下にTerraformファイルを配置
  - `main.tf`: プロバイダー設定
  - `variables.tf`: 変数定義
  - `outputs.tf`: 出力定義
  - `*.tf`: リソース定義（機能ごとに分割）

## 実装規約

- **リソース定義**: 機能ごとにファイルを分割（例: `service_account.tf`, `gcs.tf`, `bigquery.tf`, `iam.tf`）
- **変数管理**: デフォルト値を設定可能な変数は`variables.tf`で定義
- **状態管理**: Terraform状態ファイル（`.tfstate`）はgit管理に含めない（`.gitignore`で除外）
- **モジュール化**: 再利用可能な設定はモジュールとして定義
- **依存関係**: リソース間の依存関係を明示的に定義（`depends_on`を適切に使用）

## 命名規約

- **リソース名**: スネークケースを使用（例: `google_service_account.data_pipeline`, `google_storage_bucket.data_lake`）
- **変数名**: スネークケースを使用（例: `project_id`, `resource_prefix`）
- **出力名**: スネークケースを使用（例: `service_account_email`, `gcs_bucket_name`）
- **ファイル名**: リソース種別に基づいて命名（例: `service_account.tf`, `gcs.tf`, `bigquery.tf`）
- **リソースプレフィックス**: `odp`を使用（プロジェクトのリソースプレフィックスに合わせる）

## 環境ごとの設定

### local環境

- ローカル開発環境で使用するリソースも定義（必要に応じて）
- 環境変数または`terraform.tfvars`で設定を管理

### dev環境

- 開発環境用のリソースを定義
- `feature-`ブランチがリモートにプッシュされた時にCI/CDで反映

### prd環境

- 本番環境用のリソースを定義
- `main`ブランチにマージされた時にCI/CDで反映

## セキュリティ

- **機密情報**: 機密情報は変数で定義し、`terraform.tfvars`ファイルはgit管理に含めない
- **状態ファイル**: `.tfstate`ファイルはgit管理に含めない（機密情報を含む可能性がある）
- **IAM権限**: 最小権限の原則に従い、必要最小限の権限のみを付与
- **リソース保護**: 重要なリソースには`force_destroy = false`や`deletion_protection`を設定

## 品質

- **DRY原則**: コードの重複を避ける（`for_each`や`for`を使用）
- **明確なコード**: リソースの`description`フィールドを適切に記述
- **バリデーション**: 変数の型チェックとバリデーションを適切に設定
- **出力**: 他のモジュールやスクリプトで使用する値は`outputs.tf`で定義

## 簡潔性

- **必要最小限の機能**: 過剰な実装は行わない
- **余計なコメント**: 説明不要なコメントは削除する
- **未使用のリソース**: 未使用のリソースや変数は削除する

## 状態管理のベストプラクティス

- **リモート状態**: 本番環境ではリモート状態バックエンド（GCS等）を使用することを推奨
- **状態ファイルのロック**: チーム開発では状態ファイルのロック機能を使用
- **バックアップ**: 重要な状態ファイルは定期的にバックアップを取得

## Terraformで管理していないリソース

以下のリソースはTerraformで管理していません（手動作成済み）:

- **GitHub Actions用のサービスアカウント**: CI/CD実行用のサービスアカウント（GitHub Secretsの`GCP_SA_KEY`で使用）
- **Terraform状態ファイル保存用のGCSバケット**: `odp-terraform-state`（リモート状態バックエンド用）
