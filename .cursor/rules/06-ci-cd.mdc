---
alwaysApply: true
---

# CI/CD開発規約

## ガイドライン

- **ドキュメント参照**: GitHub Actions公式ドキュメントを優先
- **CI/CDツール**: GitHub Actionsを使用
- **認証情報の管理**: CI/CD利用時に必要な認証情報はGitHub Secretsを使用

## 実装規約

- **CIワークフロー**: `feature-`で始まるブランチから`main`へのPull Requestが作成・更新されたときに実行
  - `gcp/**`ディレクトリの変更があった場合のみTerraformのフォーマットチェック、バリデーション、プランを実行
  - `dbt/**`ディレクトリの変更があった場合のみdbt parseを実行
  - `dagster_project/**`ディレクトリの変更があった場合のみDagsterのフォーマットチェック、リンター、定義検証を実行

- **CDワークフロー（stg環境）**: `main`ブランチにマージされたときに実行
  - 変更されたファイルパスを検知して自動的にデプロイ
  - `gcp/**`ディレクトリの変更があった場合、Terraformのプランと適用を実行
  - `dbt/**`ディレクトリの変更があった場合、dbt runを実行
  - `dagster_project/**`または`dbt/**`ディレクトリの変更があった場合、Dagsterジョブを実行
  - `environment: staging`を設定

- **CDワークフロー（prd環境）**: 手動トリガー（workflow_dispatch）で実行
  - Terraform、dbt、Dagsterのデプロイを個別に選択可能
  - `environment: production`を設定し、リソース変更時に承認が必要

## 命名規約

- **ワークフローファイル名**: スネークケースを使用（例: `terraform_ci.yml`, `terraform_cd.yml`)

## セキュリティ

- **機密情報**: GitHub Secretsで管理（ハードコード禁止）
- **サービスアカウント**: GitHub Actions用のサービスアカウントは作成済みのものを使用

## 品質

- **必要最小限のステップ**: 運用に必要十分な機能のみを保持し、過剰な実装は行わない
- **エラーハンドリング**: ステップが失敗した場合は、その時点でジョブを中止する（デフォルトで有効）

## 簡潔性

- **必要最小限の機能**: 過剰な実装は行わない
- **GitHub Secrets**: 必須項目のみ設定
  - `GCP_SA_KEY`: GCPサービスアカウントキー（JSON形式、Terraform実行に必要な権限）
