name: CI

on:
  pull_request:
    branches:
      - main

jobs:
  terraform-check:
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'feature-')
    defaults:
      run:
        working-directory: ./gcp
    outputs:
      completed: ${{ job.status == 'success' || job.status == 'skipped' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if gcp directory changed
        id: check_paths
        uses: dorny/paths-filter@v3
        with:
          filters: |
            gcp:
              - 'gcp/**'

      - name: Setup Terraform
        if: steps.check_paths.outputs.gcp == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Authenticate to Google Cloud
        if: steps.check_paths.outputs.gcp == 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Format Check
        if: steps.check_paths.outputs.gcp == 'true'
        run: terraform fmt -check -recursive

      - name: Terraform Init
        if: steps.check_paths.outputs.gcp == 'true'
        run: terraform init -upgrade=false

      - name: Terraform Validate
        if: steps.check_paths.outputs.gcp == 'true'
        run: terraform validate

      - name: Terraform Plan
        if: steps.check_paths.outputs.gcp == 'true'
        run: terraform plan -no-color

  dagster-check:
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'feature-')
    needs: [terraform-check, dbt-check]
    defaults:
      run:
        working-directory: ./dagster_project

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if dagster_project directory changed
        id: check_paths
        uses: dorny/paths-filter@v3
        with:
          filters: |
            dagster:
              - 'dagster_project/**'

      - name: Setup Python
        if: steps.check_paths.outputs.dagster == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        if: steps.check_paths.outputs.dagster == 'true'
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        if: steps.check_paths.outputs.dagster == 'true'
        run: uv sync --extra dev

      - name: Black Format Check
        if: steps.check_paths.outputs.dagster == 'true'
        run: uv run black --check --line-length 100 .

      - name: Ruff Lint
        if: steps.check_paths.outputs.dagster == 'true'
        run: uv run ruff check .

      - name: Verify Dagster Definitions
        if: steps.check_paths.outputs.dagster == 'true'
        env:
          DBT_TARGET: stg
          DBT_ENV: stg
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'olist-data-portal' }}
        run: uv run dagster definitions validate -w olist_data_portal/workspace.yaml

  dbt-check:
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'feature-')
    needs: [terraform-check]
    defaults:
      run:
        working-directory: ./dagster_project
    outputs:
      completed: ${{ job.status == 'success' || job.status == 'skipped' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if dbt directory changed
        id: check_paths
        uses: dorny/paths-filter@v3
        with:
          filters: |
            dbt:
              - 'dbt/**'

      - name: Setup Python
        if: steps.check_paths.outputs.dbt == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        if: steps.check_paths.outputs.dbt == 'true'
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        if: steps.check_paths.outputs.dbt == 'true'
        run: uv sync --extra dev

      - name: Authenticate to Google Cloud
        if: steps.check_paths.outputs.dbt == 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: dbt Parse
        if: steps.check_paths.outputs.dbt == 'true'
        env:
          DBT_TARGET: stg
          DBT_ENV: stg
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'olist-data-portal' }}
        run: |
          cd ../dbt
          uv run --directory ../dagster_project dbt parse --profiles-dir . --project-dir .

