name: Deploy to Staging

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      terraform: ${{ steps.filter.outputs.terraform }}
      dbt: ${{ steps.filter.outputs.dbt }}
      dagster: ${{ steps.filter.outputs.dagster }}
      dbt_models: ${{ steps.dbt_models.outputs.models }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check changed files
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            terraform:
              - 'gcp/**'
            dbt:
              - 'odp/**'
            dagster:
              - 'dagster_project/**'

      - name: Extract changed dbt models
        if: steps.filter.outputs.dbt == 'true'
        id: dbt_models
        run: |
          # Get changed files between previous commit and current commit
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- 'odp/models/**/*.sql' || git diff --name-only HEAD~1 HEAD -- 'odp/models/**/*.sql')
          MODELS=""
          if [ -n "$CHANGED_FILES" ]; then
            for file in $CHANGED_FILES; do
              # Extract model name from file path (e.g., odp/models/staging/stg_orders.sql -> stg_orders)
              model=$(basename "$file" .sql)
              if [ -n "$MODELS" ]; then
                MODELS="$MODELS,$model"
              else
                MODELS="$model"
              fi
            done
          fi
          echo "models=$MODELS" >> $GITHUB_OUTPUT
          echo "Changed models: $MODELS"

  deploy-stg:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.terraform == 'true' || needs.detect-changes.outputs.dbt == 'true' || needs.detect-changes.outputs.dagster == 'true'
    environment: staging
    defaults:
      run:
        working-directory: ./dagster_project

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Terraform
        if: needs.detect-changes.outputs.terraform == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Deploy Terraform
        if: needs.detect-changes.outputs.terraform == 'true'
        working-directory: ./gcp
        run: |
          terraform init -upgrade=false
          terraform plan -no-color -out=tfplan
          terraform apply -auto-approve -no-color tfplan

      - name: Run dbt
        if: needs.detect-changes.outputs.dbt == 'true'
        env:
          DBT_TARGET: stg
          DBT_ENV: stg
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'olist-data-portal' }}
          GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME || 'odp-data-lake' }}
        run: |
          cd ../odp
          CHANGED_MODELS="${{ needs.detect-changes.outputs.dbt_models }}"
          if [ -n "$CHANGED_MODELS" ]; then
            echo "Running changed models and their dependents: $CHANGED_MODELS"
            # Use + to include dependents of changed models
            # --full-refresh for incremental models in staging environment
            uv run --directory ../dagster_project dbt run --select "$CHANGED_MODELS+" --full-refresh --profiles-dir . --project-dir .
          else
            echo "No specific models changed, running all models"
            uv run --directory ../dagster_project dbt run --full-refresh --profiles-dir . --project-dir .
          fi

      - name: Run Dagster Assets
        if: needs.detect-changes.outputs.dagster == 'true' || needs.detect-changes.outputs.dbt == 'true'
        env:
          DBT_TARGET: stg
          DBT_ENV: stg
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'olist-data-portal' }}
          GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME || 'odp-data-lake' }}
        run: |
          uv run dagster job execute -j olist_data_portal_job -w olist_data_portal/workspace.yaml

